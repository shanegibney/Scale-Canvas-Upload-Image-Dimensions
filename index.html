<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title></title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" crossorigin="anonymous">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" crossorigin="anonymous"></script>
  <script src="https://rawgit.com/eligrey/FileSaver.js/master/FileSaver.js"></script>
  <script src="https://rawgit.com/eligrey/canvas-toBlob.js/master/canvas-toBlob.js"></script>
</head>
<style>
  canvas {
    border-width: 100%;
    /*border: black 3px solid;*/
  }

  #dimensions {
    background-color: lightblue;
    border: lightgray 3px solid;
  }
</style>

<body>
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-12 upload_form">
        <input type="file" id="imageLoader" name="imageLoader" value="A1.png" />
        <button type="button" onclick="download_image()" name="button">Save .png</button>
        <button type="button" onclick="createSCAD()" name="button">Create .SCAD</button>
      </div>
    </div>
    <div class=row>
      <div class="col-md-2" id="dimensions">
        <h5>Dimensions:</h5>
      </div>
      <div class="col-md-10">
        <canvas id="canvas"></canvas>
      </div>
    </div>
  </div>
</body>
<script type="text/javascript">
  var Pts = [];
  var dist;
  var inputValue;
  var ratio;
  var angle;
  var var_name;

  window.addEventListener('load', function() {
    var imageLoader = document.getElementById('imageLoader');
    imageLoader.addEventListener('change', handleImage, false);
    var c = document.getElementById('canvas');
    var ctx = c.getContext('2d');

    function handleImage(e) {
      var reader = new FileReader();
      reader.onload = function(event) {
        var img = new Image();
        img.onload = function() {
          c.width = img.width;
          c.height = img.height;
          ctx.drawImage(img, 0, 0);
        }
        img.src = event.target.result;
      }
      reader.readAsDataURL(e.target.files[0]);
    }

    $("#canvas").click(function(e) {
      getPosition(e);
    });
  });

  var pointSize = 3;

  // Event will be a click event which can be retrieved as first parameter in the addEventListener(function(event){}); or in jQuery with $("selector").click(function(event){});
  function getPosition(event) {
    console.log("running getPosition()");
    var rect = canvas.getBoundingClientRect();
    var x = event.clientX - rect.left; // x == the location of the click in the document - the location (relative to the left) of the canvas in the document
    var y = event.clientY - rect.top; // y == the location of the click in the document - the location (relative to the top) of the canvas in the document

    Pts.push({
      x: x,
      y: y
    });

    // if (Pts.length == 2) {
    //   dist = getDistance();
    //   addInput(Pts[1].x, Pts[1].y);
    // }

    drawCoordinates(x, y);

    // Every time an even number of points created
    if (Pts.length % 2 == 0) {
      drawLine(Pts[Pts.length - 2].x, Pts[Pts.length - 2].y, Pts[Pts.length - 1].x, Pts[Pts.length - 1].y);
      addInput(Pts[Pts.length - 2].x, Pts[Pts.length - 2].y);
    };
    console.log(Pts);
  }

  function drawCoordinates(x, y) {
    console.log("running drawCoordinates()");
    var pointSize = 3; // Change according to the size of the point.
    var ctx = document.getElementById("canvas").getContext("2d");
    if (Pts.length < 3) {
      ctx.fillStyle = "blue"; // Red color
    } else {
      ctx.fillStyle = "red"; // Red color
    }
    ctx.beginPath(); //Start path
    ctx.arc(x, y, pointSize, 0, Math.PI * 2, true); // Draw a point using the arc function of the canvas with a point structure.
    ctx.fill(); // Close the path and fill.
  }

  function drawLine(x1, y1, x2, y2) {
    console.log("running drawLine()");
    var ctx = document.getElementById("canvas").getContext("2d");
    ctx.beginPath();
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    if (Pts.length < 3) {
      ctx.strokeStyle = 'blue';
    } else {
      ctx.strokeStyle = 'black';
    }
    ctx.stroke();
    // dist = getDistance();
    // txt = dist * ratio;

    // if (Pts.length > 2) {
    //   txt = Pts[Pts.length - 3].name + " = " + dist;
    //   drawText(txt, x1, y1, x2, y2);
    // }
  }

  function addInput(x, y) {
    console.log("running addInput()");
    // var newDiv = document.createElement('div');

    var input = document.createElement('input');
    input.type = 'text';
    input.name = 'item';
    if (Pts.length == 2) {
      input.placeholder = "reference distance";
    } else {
      input.placeholder = "dimension name"
    }
    input.style.position = 'fixed';
    input.style.left = (x + 4) + 'px';
    input.style.top = (y + 4) + 'px';
    input.onkeydown = handleEnter;
    document.body.appendChild(input);
    input.focus();
    hasInput = true;

    // var itemLabel = document.createElement('Label');
    // itemLabel.setAttribute('for', item);
    // itemLabel.innerHTML = 'Item: ';
    // newDiv.insertBefore(itemLabel, item);
    // drawLine(Pts[Pts.length - 2].x, Pts[Pts.length - 2].y, Pts[Pts.length - 1].x, Pts[Pts.length - 1].y);
  }

  function handleEnter(e) {
    console.log("running handleEnter()");
    var keyCode = e.keyCode;
    if (keyCode === 13) {
      inputValue = this.value; // input ratio or variable name
      Pts[Pts.length - 1].name = this.value;
      Pts[Pts.length - 1].dist = (ratio * dist).toFixed(2);
      document.body.removeChild(this);
      hasInput = false;
      // if (Pts.length > 2) {
      // ratio = inputValue / dist; // ratio only set once
      // drawText("reference line = " + dist * ratio, Pts[Pts.length - 2].x, Pts[Pts.length - 2].y, Pts[Pts.length - 1].x, Pts[Pts.length - 1].y);

      updateObject(); // add variable or line name to object
      console.log("name: " + Pts[Pts.length - 1].name);
      console.log(Pts);
      getDistance();
      console.log("Dist: " + dist);

      if (Pts.length == 2) {
        console.log("inputValue: " + inputValue);
        console.log("dist: " + dist);

        ratio = inputValue / dist; // ratio only set once
        console.log("ratio: " + ratio);
        txt = "reference line = " + (dist * ratio).toFixed(2);
      } else {
        console.log("name: " + Pts[Pts.length - 1].name);
        txt = Pts[Pts.length - 1].name + " = " + (dist * ratio).toFixed(2);
      }
      console.log("txt: " + txt);
      drawText(txt, Pts[Pts.length - 2].x, Pts[Pts.length - 2].y, Pts[Pts.length - 1].x, Pts[Pts.length - 1].y);
    }
  }

  function getDistance() {
    console.log("running getDistance()");
    dist = Math.sqrt(Math.pow(Math.abs(Pts[Pts.length - 2].x - Pts[Pts.length - 1].x), 2) + Math.pow(Math.abs(Pts[Pts.length - 2].y -
      Pts[Pts.length - 1].y), 2));
    return dist
  }

  function updateObject() {
    console.log("running updateObject()");
    if (Pts.length > 2) {
      console.log("length: " + Pts.length);
      Pts[Pts.length - 1].name = inputValue;
    }
  }

  function drawText(txt, x1, y1, x2, y2) {
    console.log("running drawText()");
    // (x,y) coordinate of text mid way between both points
    x = ((x2 + x1) / 2) + 5;
    y = ((y2 + y1) / 2) + 5;
    var ctx = document.getElementById("canvas").getContext("2d");
    ctx.save();
    ctx.textBaseline = 'top';
    ctx.textAlign = 'left';
    // ctx.font = font;
    // angle = Math.atan((Math.abs(y2 - y1)) / (Math.abs(x2 - x1)));
    // console.log(angle);
    ctx.translate(x, y)
    // ctx.rotate(-1 * angle);
    ctx.fillText(txt, 0, 0);
    ctx.restore();
    ctx.textBaseline = 'top';
    ctx.textAlign = 'left';
    ctx.fillText(txt, 10, Pts.length * 7);
    old_html = document.getElementById("dimensions").innerHTML;
    document.getElementById("dimensions").innerHTML = old_html + "<br>" + txt;
  }

  function createSCAD() {
    var fileContent = "";
    for (var i = 2; i < Pts.length; i++) {
      // fileContent += Pts[i + 1].name;
      if (i % 2 == 0) {
        fileContent += Pts[i + 1].name + " = " + Pts[i + 1].dist + "\r\n";
      }
    }
    var file = new File([fileContent], "file.scad", {
      type: "text/plain;charset=utf-8"
    });
    saveAs(file);
  }

  function download_image() {
    // Dump the canvas contents to a file.
    var canvas = document.getElementById("canvas");
    var today = new Date();
    var date = today.getFullYear() + "" + (today.getMonth() + 1) + "" + "" + today.getDate() + "" + (today.getHours() - 2) + "" + today.getMinutes() + "" + today.getSeconds();
    today.getDate();
    canvas.toBlob(function(blob) {
      saveAs(blob, date + "Canvas.png");
    }, "image/png");
  };
</script>

</html>
